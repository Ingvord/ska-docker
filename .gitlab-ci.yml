# GitLab CI in conjunction with GitLab Runner can use Docker Engine to test and build any application.
# Docker, when used with GitLab CI, runs each job in a separate and isolated container using the predefined image that is set up in .gitlab-ci.yml.
image: registry.gitlab.com/ska-telescope/ska-docker/tango-builder:latest

services:
  - docker:dind
  
# During the development of software, there can be many stages until it's ready for public consumption. 
# You sure want to first test your code and then deploy it in a testing or staging environment before you release it to the public. 
# That way you can prevent bugs not only in your software, but in the deployment process as well. 
# See also https://docs.gitlab.com/ee/ci/environments.html
stages:
  - build_1
  - build_2
  - build_3
  - test

before_script:
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

build_dependencies:
  stage: build_1
  tags:
    - engageska
    - docker-machine
  script: 
    - cd docker/tango/tango-dependencies
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual

build_tango-db:
  stage: build_1
  tags:
  - engageska
  - docker-machine
  script:
  - cd docker/tango/tango-db
  - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
  - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual

build_tango-builder:
  stage: build_1
  tags:
    - engageska
    - docker-machine
  script:
    - cd docker/tango/tango-builder
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual

build_tango-cpp:
  stage: build_2
  tags:
    - engageska
    - docker-machine
  script: 
    - cd docker/tango/tango-cpp
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual
  
build_tango-java:
  stage: build_2
  tags:
    - engageska 
    - docker-machine
  script: 
    - cd docker/tango/tango-java
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual
  
build_tango-python:
  stage: build_2
  tags:
    - shell
  script:
    - cd docker/tango/tango-python
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual
  
build_tango-rest:
  stage: build_3
  tags:
    - engageska
    - docker-machine
  script:
    - cd docker/tango/tango-rest
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual

build_tango-itango:
  stage: build_3
  tags:
  - engageska
  - docker-machine
  script:
  - cd docker/tango/tango-itango
  - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
  - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual

build_tango-pogo:
  stage: build_3
  tags:
    - engageska
    - docker-machine
  script: 
    - cd docker/tango/tango-pogo
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual

build_tango-starter:
  stage: build_3
  tags:
    - engageska 
    - docker-machine
  script: 
    - cd docker/tango/tango-starter
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST build
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST push
  when: manual

test-framework-tango-python:
  stage: test
  tags:
    - engageska
    - docker-machine
  script:
    - mkdir .public
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST -C docker/tango/tango-python test > .public/result.txt
    - mv .public public
  artifacts:
    paths:
    - public

test-framework-tango-itango:
  stage: test
  tags:
  - engageska
  - docker-machine
  script:
  - mkdir .public
  - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST -C docker/tango/tango-itango test > .public/result.txt
  - mv .public public
  artifacts:
    paths:
    - public

test-framework-tango-rest:
  stage: test
  tags:
    - engageska
    - docker-machine
  script:
    - mkdir .public
    - make DOCKER_REGISTRY_USER=$DOCKER_REGISTRY_USER DOCKER_REGISTRY_HOST=$DOCKER_REGISTRY_HOST -C docker/tango/tango-test test > .public/result.txt
    - mv .public public
  artifacts:
    paths:
    - public 
  